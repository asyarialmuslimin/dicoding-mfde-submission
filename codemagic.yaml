workflows:
  default-workflow:
    name: Flutter Test & Build
    max_build_duration: 60
    instance_type: linux_x2
    
    environment:
      flutter: stable
      vars:
        JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
    
    cache:
      cache_paths:
        - $HOME/.gradle/caches
        - $HOME/.pub-cache
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: '*'
          include: true
          source: true
      cancel_previous_builds: true
    
    scripts:
      # 1. Install dependencies hanya di root
      - name: Install dependencies
        script: |
          echo "ğŸ“¦ Installing dependencies..."
          flutter pub get
          echo "âœ… Dependencies installed successfully!"
      
      # 2. Run Flutter analyzer
      - name: Run Flutter analyzer
        script: |
          echo "ğŸ” Running Flutter analyzer..."
          flutter analyze
        ignore_failure: false
      
      # 3. Run tests untuk semua module secara dinamis
      - name: Run tests for all modules
        script: |
          echo "ğŸ§ª Running tests for all modules..."
          echo ""
          
          # Variable untuk track test failures
          TEST_FAILED=0
          
          # Loop semua direktori yang memiliki folder test
          for dir in */; do
            dir_name="${dir%/}"
            if [ -d "$dir_name/test" ]; then
              echo "  â†’ Running tests in $dir_name module..."
              if flutter test "$dir_name/test"; then
                echo "    âœ… Tests passed in $dir_name"
              else
                echo "    âŒ Tests failed in $dir_name"
                TEST_FAILED=1
              fi
              echo ""
            fi
          done
          
          # Check jika ada test yang fail
          if [ $TEST_FAILED -eq 1 ]; then
            echo "âŒ Some tests failed!"
            exit 1
          else
            echo "âœ… All tests passed!"
          fi
      
      # 4. Build Android
      - name: Build Android APK
        script: |
          echo "ğŸ”¨ Building Android APK..."
          flutter build apk --release
      
      - name: Build Android App Bundle
        script: |
          echo "ğŸ”¨ Building Android App Bundle..."
          flutter build appbundle --release
    
    artifacts:
      - build/**/outputs/**/*.apk
      - build/**/outputs/**/*.aab
      - build/**/outputs/**/mapping.txt
